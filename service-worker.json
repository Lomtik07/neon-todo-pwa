// service-worker.js
const CACHE_NAME = 'neon-todo-pwa-v1.0';
const STATIC_CACHE = 'neon-todo-static-v1.0';
const DYNAMIC_CACHE = 'neon-todo-dynamic-v1.0';

// –§–∞–π–ª—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
const STATIC_FILES = [
  '/',
  '/index.html',
  '/manifest.json',
  '/icons/icon-192x192.png',
  '/icons/icon-512x512.png'
];

// –ò–º–∏—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ API (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
const MOCK_API_URL = 'https://api.neon-todo.example.com';

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Service Worker
self.addEventListener('install', event => {
  console.log('[Service Worker] –£—Å—Ç–∞–Ω–æ–≤–∫–∞...');
  
  event.waitUntil(
    caches.open(STATIC_CACHE)
      .then(cache => {
        console.log('[Service Worker] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤');
        return cache.addAll(STATIC_FILES);
      })
      .then(() => {
        console.log('[Service Worker] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        return self.skipWaiting();
      })
      .catch(error => {
        console.error('[Service Worker] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
      })
  );
});

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è Service Worker
self.addEventListener('activate', event => {
  console.log('[Service Worker] –ê–∫—Ç–∏–≤–∞—Ü–∏—è...');
  
  event.waitUntil(
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫—ç—à–∏
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== STATIC_CACHE && cacheName !== DYNAMIC_CACHE) {
            console.log('[Service Worker] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
    .then(() => {
      console.log('[Service Worker] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      return self.clients.claim();
    })
  );
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
self.addEventListener('fetch', event => {
  const request = event.request;
  
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ-GET –∑–∞–ø—Ä–æ—Å—ã –∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –¥—Ä—É–≥–∏–º –¥–æ–º–µ–Ω–∞–º
  if (request.method !== 'GET' || !request.url.startsWith(self.location.origin)) {
    return;
  }
  
  event.respondWith(
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
    caches.match(request)
      .then(cachedResponse => {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ –∫—ç—à–∞
        if (cachedResponse) {
          console.log('[Service Worker] –ó–∞–ø—Ä–æ—Å –∏–∑ –∫—ç—à–∞:', request.url);
          return cachedResponse;
        }
        
        // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Å–µ—Ç–∏
        return fetch(request)
          .then(networkResponse => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            if (!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'basic') {
              return networkResponse;
            }
            
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
            const responseToCache = networkResponse.clone();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à
            caches.open(DYNAMIC_CACHE)
              .then(cache => {
                cache.put(request, responseToCache);
                console.log('[Service Worker] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—ç—à:', request.url);
              });
            
            return networkResponse;
          })
          .catch(error => {
            console.log('[Service Worker] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            
            // –î–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –æ—Ñ–ª–∞–π–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (request.url.endsWith('/') || request.url.includes('index.html')) {
              return caches.match('/')
                .then(cachedIndex => {
                  if (cachedIndex) {
                    return cachedIndex;
                  }
                  
                  // Fallback –æ—Ñ–ª–∞–π–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü–∞
                  return new Response(
                    `
                    <!DOCTYPE html>
                    <html lang="ru">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>–ù–µ–æ–Ω–æ–≤—ã–π To-Do</title>
                        <style>
                            body {
                                background: #0a0a1a;
                                color: white;
                                font-family: sans-serif;
                                text-align: center;
                                padding: 50px 20px;
                            }
                            h1 { color: #00f3ff; }
                            .offline-icon { font-size: 60px; margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="offline-icon">üì¥</div>
                        <h1>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω</h1>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</p>
                        <p>–í–∞—à–∏ –∑–∞–¥–∞—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ –∏ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏.</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #00f3ff; border: none; border-radius: 10px; color: #0a0a1a; cursor: pointer;">
                            –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </body>
                    </html>
                    `,
                    {
                      headers: { 'Content-Type': 'text/html' }
                    }
                  );
                });
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
            return new Response(
              JSON.stringify({ 
                error: '–û—Ñ–ª–∞–π–Ω', 
                message: '–≠—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞' 
              }),
              {
                status: 503,
                headers: { 'Content-Type': 'application/json' }
              }
            );
          });
      })
  );
});

// –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
self.addEventListener('sync', event => {
  console.log('[Service Worker] Sync —Å–æ–±—ã—Ç–∏–µ:', event.tag);
  
  switch (event.tag) {
    case 'sync-tasks':
      event.waitUntil(syncTasks());
      break;
      
    case 'manual-sync':
      event.waitUntil(syncWithServer());
      break;
      
    default:
      console.log('[Service Worker] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', event.tag);
  }
});

// –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
self.addEventListener('message', event => {
  console.log('[Service Worker] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:', event.data);
  
  const { type, data } = event.data;
  
  switch (type) {
    case 'APP_LOADED':
      console.log('[Service Worker] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∑–∞–¥–∞—á:', data.taskCount);
      // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
      event.ports[0]?.postMessage({
        type: 'WELCOME',
        data: { message: 'Service Worker –∞–∫—Ç–∏–≤–µ–Ω' }
      });
      break;
      
    case 'GET_TASKS':
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ IndexedDB
      event.ports[0]?.postMessage({
        type: 'TASKS_DATA',
        data: { tasks: [] } // –ó–∞–≥–ª—É—à–∫–∞
      });
      break;
      
    case 'SKIP_WAITING':
      self.skipWaiting();
      break;
  }
});

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ñ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
self.addEventListener('periodicsync', event => {
  if (event.tag === 'update-cache') {
    event.waitUntil(updateCache());
  }
});

// ==================== –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ====================

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á
async function syncTasks() {
  console.log('[Service Worker] –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á');
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ localStorage —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
    const tasks = await getTasksFromClient();
    
    if (tasks.length === 0) {
      console.log('[Service Worker] –ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
      sendMessageToClients({
        type: 'SYNC_COMPLETE',
        data: { taskCount: 0, message: '–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏' }
      });
      return;
    }
    
    console.log(`[Service Worker] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º ${tasks.length} –∑–∞–¥–∞—á`);
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // –ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞—á–∏ –∫–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
    const syncedTasks = tasks.map(task => ({
      ...task,
      synced: true,
      lastSync: new Date().toISOString()
    }));
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–ª–∏–µ–Ω—Ç
    await saveTasksToClient(syncedTasks);
    
    console.log('[Service Worker] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º
    sendMessageToClients({
      type: 'SYNC_COMPLETE',
      data: { 
        taskCount: tasks.length,
        syncedAt: new Date().toISOString()
      }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification('–ó–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${tasks.length} –∑–∞–¥–∞—á`);
    
  } catch (error) {
    console.error('[Service Worker] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
    
    sendMessageToClients({
      type: 'SYNC_ERROR',
      data: { error: error.message }
    });
    
    // –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
    self.registration.sync.register('sync-tasks')
      .then(() => console.log('[Service Worker] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞'))
      .catch(err => console.error('[Service Worker] –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', err));
  }
}

// –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
async function syncWithServer() {
  console.log('[Service Worker] –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
  
  try {
    // 1. –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–∏–º–∏—Ç–∞—Ü–∏—è)
    const serverTasks = await fetchMockServerData();
    
    // 2. –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
    const localTasks = await getTasksFromClient();
    
    // 3. –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–¥–∞—á–∏
    const mergedTasks = mergeTasks(localTasks, serverTasks);
    
    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
    await saveTasksToClient(mergedTasks);
    
    console.log('[Service Worker] –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    
    sendMessageToClients({
      type: 'MANUAL_SYNC_COMPLETE',
      data: {
        taskCount: mergedTasks.length,
        localCount: localTasks.length,
        serverCount: serverTasks.length,
        timestamp: new Date().toISOString()
      }
    });
    
    showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${mergedTasks.length} –∑–∞–¥–∞—á`);
    
  } catch (error) {
    console.error('[Service Worker] –û—à–∏–±–∫–∞ —Ä—É—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
    
    sendMessageToClients({
      type: 'SYNC_ERROR',
      data: { error: error.message }
    });
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
async function updateCache() {
  console.log('[Service Worker] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞...');
  
  try {
    const cache = await caches.open(STATIC_CACHE);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
    for (const url of STATIC_FILES) {
      try {
        const response = await fetch(url);
        if (response.ok) {
          await cache.put(url, response);
          console.log(`[Service Worker] –û–±–Ω–æ–≤–ª–µ–Ω –∫—ç—à –¥–ª—è: ${url}`);
        }
      } catch (error) {
        console.log(`[Service Worker] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å: ${url}`, error);
      }
    }
    
    console.log('[Service Worker] –ö—ç—à –æ–±–Ω–æ–≤–ª–µ–Ω');
  } catch (error) {
    console.error('[Service Worker] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞:', error);
  }
}

// ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
function getTasksFromClient() {
  return new Promise((resolve) => {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á
    self.clients.matchAll().then(clients => {
      if (clients.length === 0) {
        resolve([]);
        return;
      }
      
      const messageChannel = new MessageChannel();
      
      messageChannel.port1.onmessage = (event) => {
        if (event.data.type === 'TASKS_RESPONSE') {
          resolve(event.data.data.tasks || []);
        } else {
          resolve([]);
        }
      };
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏ —É –∫–ª–∏–µ–Ω—Ç–∞
      clients[0].postMessage({
        type: 'GET_TASKS_FOR_SYNC'
      }, [messageChannel.port2]);
      
      // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—Ç–≤–µ—Ç–∞
      setTimeout(() => resolve([]), 1000);
    });
  });
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –∫–ª–∏–µ–Ω—Ç
function saveTasksToClient(tasks) {
  return new Promise((resolve) => {
    self.clients.matchAll().then(clients => {
      if (clients.length === 0) {
        resolve();
        return;
      }
      
      clients.forEach(client => {
        client.postMessage({
          type: 'UPDATE_TASKS',
          data: { tasks }
        });
      });
      resolve();
    });
  });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
function sendMessageToClients(message) {
  self.clients.matchAll().then(clients => {
    clients.forEach(client => {
      client.postMessage(message);
    });
  });
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(title, body) {
  if (self.Notification.permission === 'granted') {
    self.registration.showNotification(title, {
      body: body,
      icon: '/icons/icon-192x192.png',
      badge: '/icons/icon-72x72.png',
      tag: 'sync-notification',
      vibrate: [200, 100, 200]
    });
  }
}

// –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchMockServerData() {
  // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏
  await new Promise(resolve => setTimeout(resolve, 800));
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  return [
    {
      id: Date.now() - 1000000,
      text: '–ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞',
      completed: false,
      date: new Date().toLocaleDateString('ru-RU'),
      createdAt: new Date(Date.now() - 86400000).toISOString(),
      synced: true
    }
  ];
}

// –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á
function mergeTasks(localTasks, serverTasks) {
  const taskMap = new Map();
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏
  serverTasks.forEach(task => {
    taskMap.set(task.id, { ...task, source: 'server' });
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
  localTasks.forEach(localTask => {
    if (taskMap.has(localTask.id)) {
      const serverTask = taskMap.get(localTask.id);
      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –±–æ–ª–µ–µ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
      const localTime = new Date(localTask.createdAt || 0);
      const serverTime = new Date(serverTask.createdAt || 0);
      
      if (localTime > serverTime) {
        taskMap.set(localTask.id, { ...localTask, source: 'local' });
      }
    } else {
      taskMap.set(localTask.id, { ...localTask, source: 'local' });
    }
  });
  
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
  return Array.from(taskMap.values())
    .map(task => {
      const { source, ...cleanTask } = task;
      return { ...cleanTask, synced: true };
    })
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
}

// Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
self.addEventListener('push', event => {
  console.log('[Service Worker] Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ');
  
  const data = event.data ? event.data.json() : {};
  const title = data.title || '–ù–µ–æ–Ω–æ–≤—ã–π To-Do';
  const options = {
    body: data.body || '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
    icon: '/icons/icon-192x192.png',
    badge: '/icons/icon-72x72.png',
    tag: 'push-notification',
    data: data.url || '/'
  };
  
  event.waitUntil(
    self.registration.showNotification(title, options)
  );
});

self.addEventListener('notificationclick', event => {
  console.log('[Service Worker] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞–∂–∞—Ç–æ');
  
  event.notification.close();
  
  event.waitUntil(
    self.clients.matchAll({ type: 'window' }).then(clients => {
      const url = event.notification.data || '/';
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –∫–ª–∏–µ–Ω—Ç, —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –µ–≥–æ
      for (const client of clients) {
        if (client.url === url && 'focus' in client) {
          return client.focus();
        }
      }
      
      // –ò–Ω–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
      if (self.clients.openWindow) {
        return self.clients.openWindow(url);
      }
    })
  );
});
